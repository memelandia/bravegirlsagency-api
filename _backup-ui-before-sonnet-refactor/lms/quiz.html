<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Evaluación - BraveGirls LMS</title>
    <link rel="stylesheet" href="lms-styles.css?v=2.22.1&t=20260112223000">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js?v=2.22.1&t=20260112223000"></script>
</head>
  <header class="lms-header">
    <div class="container">
      <div class="lms-logo">🎓 BraveGirls LMS</div>
      <nav class="lms-nav">
        <a href="#" onclick="goBack()">← Volver</a>
        <div class="user-info">
          <span id="userName"></span>
        </div>
      </nav>
    </div>
  </header>

  <div class="container">
    <!-- Breadcrumb -->
    <nav class="breadcrumb">
      <div class="breadcrumb-item">
        <i class="fas fa-home"></i>
        <a href="/lms/campus.html">Campus</a>
      </div>
      <span class="breadcrumb-separator">›</span>
      <div class="breadcrumb-item">
        <a href="#" onclick="goBack(); return false;">Módulo</a>
      </div>
      <span class="breadcrumb-separator">›</span>
      <div class="breadcrumb-item">
        <span class="breadcrumb-current">Evaluación</span>
      </div>
    </nav>

    <div id="alert" class="hidden"></div>
    <div id="quizContent">
      <div class="spinner"></div>
    </div>
  </div>

  <script>
    // URL base del API en Vercel
    const API_BASE = 'https://bravegirlsagency-api.vercel.app/api/lms';
    
    const urlParams = new URLSearchParams(window.location.search);
    const moduleId = urlParams.get('moduleId');
    let currentUser = null;
    let quizData = null;
    let answers = {};

    function showAlert(message, type = 'error') {
      const alertDiv = document.getElementById('alert');
      alertDiv.className = `alert alert-${type}`;
      alertDiv.textContent = message;
      alertDiv.classList.remove('hidden');
      window.scrollTo(0, 0);
    }

    async function checkAuth() {
      try {
        const response = await fetch(`${API_BASE}/auth/me`, { credentials: 'include' });
        if (!response.ok) throw new Error('Not authenticated');
        const data = await response.json();
        currentUser = data.user;
        document.getElementById('userName').textContent = currentUser.name;
      } catch (error) {
        window.location.href = '/lms/login.html';
      }
    }

    async function loadQuiz() {
      try {
        const response = await fetch(`${API_BASE}/quiz/${moduleId}`, { credentials: 'include' });
        if (!response.ok) {
          const data = await response.json();
          throw new Error(data.error || 'Error al cargar el quiz');
        }
        
        quizData = await response.json();
        showQuizPreview();
        
      } catch (error) {
        showAlert(error.message);
        setTimeout(() => window.location.href = `/lms/module.html?id=${moduleId}`, 2000);
      }
    }

    function showQuizPreview() {
      const container = document.getElementById('quizContent');
      container.innerHTML = '';
      
      const previewCard = document.createElement('div');
      previewCard.className = 'card';
      previewCard.style.maxWidth = '600px';
      previewCard.style.margin = '40px auto';
      previewCard.style.textAlign = 'center';
      
      previewCard.innerHTML = `
        <div style="font-size: 48px; margin-bottom: 20px;">📝</div>
        <h1 style="margin-bottom: 15px;">Evaluación Final del Módulo</h1>
        <p style="color: var(--text-secondary); margin-bottom: 30px;">
          Antes de comenzar, revisa los detalles de esta evaluación
        </p>
        
        <div style="background: var(--bg-light); border-radius: 12px; padding: 25px; margin-bottom: 30px; text-align: left;">
          <div style="display: grid; gap: 15px;">
            <div style="display: flex; align-items: center; gap: 12px;">
              <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); border-radius: 10px; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600;">
                ${quizData.questions.length}
              </div>
              <div>
                <div style="font-weight: 600; color: var(--text);">Número de preguntas</div>
                <div style="font-size: 14px; color: var(--text-secondary);">Todas son obligatorias</div>
              </div>
            </div>
            
            <div style="display: flex; align-items: center; gap: 12px;">
              <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); border-radius: 10px; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600;">
                ${quizData.quiz.passingScore}%
              </div>
              <div>
                <div style="font-weight: 600; color: var(--text);">Puntaje requerido para aprobar</div>
                <div style="font-size: 14px; color: var(--text-secondary);">Debes obtener al menos este puntaje</div>
              </div>
            </div>
            
            <div style="display: flex; align-items: center; gap: 12px;">
              <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); border-radius: 10px; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600;">
                ${quizData.quiz.attemptsRemaining}
              </div>
              <div>
                <div style="font-weight: 600; color: var(--text);">Intentos disponibles</div>
                <div style="font-size: 14px; color: var(--text-secondary);">Si no apruebas, puedes reintentar</div>
              </div>
            </div>
            
            <div style="display: flex; align-items: center; gap: 12px;">
              <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); border-radius: 10px; display: flex; align-items: center; justify-content: center; color: white;">
                <i class="fas fa-clock"></i>
              </div>
              <div>
                <div style="font-weight: 600; color: var(--text);">Duración estimada</div>
                <div style="font-size: 14px; color: var(--text-secondary);">${Math.ceil(quizData.questions.length * 1.5)} minutos aproximadamente</div>
              </div>
            </div>
          </div>
        </div>
        
        <div style="background: #fef3c7; border: 1px solid #fbbf24; border-radius: 12px; padding: 15px; margin-bottom: 30px; text-align: left;">
          <div style="display: flex; gap: 10px;">
            <div style="color: #f59e0b; font-size: 20px;">⚠️</div>
            <div>
              <div style="font-weight: 600; color: #92400e; margin-bottom: 5px;">Importante</div>
              <ul style="margin: 0; padding-left: 20px; color: #78350f; font-size: 14px;">
                <li>Lee cada pregunta cuidadosamente antes de responder</li>
                <li>Una vez enviadas las respuestas, no podrás modificarlas</li>
                <li>Asegúrate de tener buena conexión a internet</li>
              </ul>
            </div>
          </div>
        </div>
        
        <div style="display: flex; gap: 12px; flex-direction: column;">
          <button onclick="startQuiz()" class="btn btn-primary" style="padding: 15px 30px; font-size: 16px; font-weight: 600;">
            <i class="fas fa-play-circle"></i> Estoy listo/a, comenzar evaluación
          </button>
          <a href="/lms/module.html?id=${moduleId}" class="btn btn-outline" style="padding: 12px 30px;">
            <i class="fas fa-book-open"></i> Repasar contenido primero
          </a>
        </div>
      `;
      
      container.appendChild(previewCard);
    }

    function startQuiz() {
      renderQuiz();
    }

    function renderQuiz() {
      const container = document.getElementById('quizContent');
      container.innerHTML = '';
      
      const header = document.createElement('div');
      header.className = 'card';
      header.innerHTML = `
        <h1 style="margin-bottom: 10px;">📝 Evaluación Final</h1>
        <p style="color: var(--text-light);">
          ${quizData.questions.length} preguntas | 
          Puntaje mínimo para aprobar: ${quizData.quiz.passingScore}% | 
          Intentos restantes: ${quizData.quiz.attemptsRemaining}
        </p>
      `;
      container.appendChild(header);
      
      const form = document.createElement('form');
      form.id = 'quizForm';
      
      quizData.questions.forEach((question, index) => {
        const questionCard = document.createElement('div');
        questionCard.className = 'quiz-question';
        
        const prompt = document.createElement('div');
        prompt.className = 'question-prompt';
        prompt.textContent = `${index + 1}. ${question.prompt}`;
        questionCard.appendChild(prompt);
        
        const optionsList = document.createElement('ul');
        optionsList.className = 'question-options';
        
        question.options.forEach((option, optionIndex) => {
          const optionItem = document.createElement('li');
          optionItem.className = 'option-item';
          
          const radio = document.createElement('input');
          radio.type = 'radio';
          radio.name = `question_${question.id}`;
          radio.value = optionIndex;
          radio.id = `q${question.id}_opt${optionIndex}`;
          
          radio.addEventListener('change', () => {
            answers[question.id] = optionIndex;
            // Visual feedback
            optionsList.querySelectorAll('.option-item').forEach(item => {
              item.classList.remove('selected');
            });
            optionItem.classList.add('selected');
          });
          
          const label = document.createElement('label');
          label.htmlFor = radio.id;
          label.style.cursor = 'pointer';
          label.style.display = 'flex';
          label.style.alignItems = 'center';
          label.textContent = option;
          
          optionItem.appendChild(radio);
          optionItem.appendChild(label);
          optionsList.appendChild(optionItem);
          
          optionItem.addEventListener('click', (e) => {
            if (e.target !== radio) {
              radio.checked = true;
              radio.dispatchEvent(new Event('change'));
            }
          });
        });
        
        questionCard.appendChild(optionsList);
        form.appendChild(questionCard);
      });
      
      const submitBtn = document.createElement('button');
      submitBtn.type = 'submit';
      submitBtn.className = 'btn btn-primary';
      submitBtn.style.width = '100%';
      submitBtn.style.padding = '15px';
      submitBtn.style.fontSize = '16px';
      submitBtn.textContent = 'Enviar Respuestas';
      form.appendChild(submitBtn);
      
      form.addEventListener('submit', handleSubmit);
      container.appendChild(form);
    }

    async function handleSubmit(e) {
      e.preventDefault();
      
      // Validate all questions answered
      if (Object.keys(answers).length < quizData.questions.length) {
        showAlert('Debes responder todas las preguntas antes de enviar', 'warning');
        return;
      }
      
      // Confirmación antes de enviar
      if (!confirm('¿Estás seguro de enviar tus respuestas? No podrás modificarlas después.')) {
        return;
      }
      
      const submitBtn = e.target.querySelector('button[type="submit"]');
      const originalText = submitBtn.textContent;
      submitBtn.disabled = true;
      submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Enviando...';
      
      try {
        const response = await fetch(`${API_BASE}/quiz/${moduleId}/submit`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ answers })
        });
        
        const data = await response.json();
        
        if (!response.ok) {
          throw new Error(data.error || 'Error al enviar respuestas');
        }
        
        showResults(data);
        
      } catch (error) {
        showAlert(error.message);
        submitBtn.disabled = false;
        submitBtn.textContent = originalText;
      }
    }

    function showResults(results) {
      const container = document.getElementById('quizContent');
      container.innerHTML = '';
      
      const resultCard = document.createElement('div');
      resultCard.className = 'card';
      
      const isPassed = results.passed;
      
      // 🎊 Celebración con confetti si aprobó
      if (isPassed) {
        celebrateSuccess(results.score);
      }
      
      resultCard.innerHTML = `
        <div style="text-align: center;">
          <div style="font-size: 64px; margin-bottom: 20px;">
            ${isPassed ? '🎉' : '😔'}
          </div>
          <h1 style="margin-bottom: 10px; color: ${isPassed ? 'var(--success)' : 'var(--error)'};">
            ${isPassed ? '¡Aprobado!' : 'No Aprobado'}
          </h1>
          <div style="font-size: 48px; font-weight: 700; margin: 20px 0;">
            ${results.score}%
          </div>
          <p style="font-size: 18px; color: var(--text-light); margin-bottom: 30px;">
            ${results.correctAnswers} de ${results.totalQuestions} respuestas correctas<br>
            Puntaje mínimo requerido: ${results.passingScore}%
          </p>
          
          ${isPassed 
            ? `
              <div class="alert alert-success" style="text-align: left; margin-bottom: 20px;">
                <strong>¡Excelente trabajo! 🎊</strong><br>
                Has demostrado tu dominio del contenido. El siguiente módulo ya está disponible.
              </div>
            `
            : ''
          }
          
          ${!isPassed && results.attemptsUsed < results.maxAttempts 
            ? `
              <div class="alert alert-info" style="text-align: left; margin-bottom: 20px;">
                <strong>Intentos restantes:</strong> ${results.maxAttempts - results.attemptsUsed}<br>
                Revisa el material y vuelve a intentarlo.
              </div>
              <button class="btn btn-primary" onclick="location.reload()">Intentar de Nuevo</button>
            `
            : !isPassed 
              ? `<div class="alert alert-error" style="text-align: left;">Has alcanzado el máximo de intentos. Contacta a tu supervisor.</div>`
              : ''
          }
          
          <button class="btn ${isPassed ? 'btn-primary' : 'btn-outline'} mt-20" onclick="goBack()">
            ${isPassed ? '✨ Continuar al Siguiente Módulo' : 'Volver al Módulo'}
          </button>
        </div>
      `;
      
      // NO mostrar respuestas correctas (seguridad anti-trampa)
      // Solo indicar que hubo errores sin revelar cuáles
      if (!isPassed && results.attemptsUsed < results.maxAttempts) {
        const tipCard = document.createElement('div');
        tipCard.className = 'card';
        tipCard.innerHTML = `
          <h2 style="margin-bottom: 15px;">💡 Recomendaciones</h2>
          <p style="color: var(--text-light); line-height: 1.6;">
            Revisa el contenido del módulo y presta especial atención a los detalles. 
            Asegúrate de entender bien cada concepto antes de volver a intentarlo.
          </p>
          <p style="color: var(--text-light); line-height: 1.6; margin-top: 15px;">
            <strong>Consejo:</strong> Toma notas mientras estudias y repasa las lecciones que consideres más complejas.
          </p>
        `;
        container.appendChild(tipCard);
      }
      
      container.insertBefore(resultCard, container.firstChild);
    }

    function celebrateSuccess(score) {
      // Efecto confetti - Más intenso si score >= 90%
      const count = score >= 90 ? 200 : 100;
      const spread = score >= 90 ? 100 : 70;
      
      // Confetti desde el centro
      confetti({
        particleCount: count,
        spread: spread,
        origin: { y: 0.6 },
        colors: ['#10b981', '#34d399', '#6ee7b7', '#fbbf24', '#f59e0b']
      });
      
      // Si es score perfecto (100%), más confetti
      if (score === 100) {
        setTimeout(() => {
          confetti({
            particleCount: 150,
            angle: 60,
            spread: 55,
            origin: { x: 0, y: 0.6 }
          });
        }, 250);
        setTimeout(() => {
          confetti({
            particleCount: 150,
            angle: 120,
            spread: 55,
            origin: { x: 1, y: 0.6 }
          });
        }, 400);
      }
    }

    function goBack() {
      if (moduleId) {
        window.location.href = `/lms/module.html?id=${moduleId}`;
      } else {
        window.location.href = '/lms/campus.html';
      }
    }

    (async () => {
      if (!moduleId || moduleId === 'null' || moduleId === 'undefined') {
        showAlert('ID de módulo inválido', 'error');
        setTimeout(() => window.location.href = '/lms/campus.html', 2000);
        return;
      }
      await checkAuth();
      await loadQuiz();
    })();
  </script>
</body>
</html>


